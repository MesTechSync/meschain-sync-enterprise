{{ header }}{{ column_left }}
<div id="content">
    <div class="page-header">
        <div class="container-fluid">
            <div class="pull-right">
                <button type="button" id="trigger-pipeline" class="btn btn-success">
                    <i class="fa fa-play"></i> {{ text_trigger_pipeline }}
                </button>
                <button type="button" id="export-devops-report" class="btn btn-primary">
                    <i class="fa fa-download"></i> {{ text_export_report }}
                </button>
                <button type="button" id="refresh-devops-data" class="btn btn-info">
                    <i class="fa fa-refresh"></i> {{ text_refresh }}
                </button>
            </div>
            <h1>{{ heading_title }}</h1>
            <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="container-fluid">
        <!-- DevOps Overview Cards -->
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-code-fork fa-5x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="huge" id="active-pipelines">0</div>
                                <div>{{ text_active_pipelines }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <span class="pull-left" id="pipelines-status">{{ text_loading }}</span>
                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="panel panel-green">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-rocket fa-5x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="huge" id="successful-deployments">0</div>
                                <div>{{ text_successful_deployments }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <span class="pull-left" id="deployments-status">{{ text_healthy }}</span>
                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="panel panel-yellow">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-flask fa-5x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="huge" id="test-coverage">0%</div>
                                <div>{{ text_test_coverage }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <span class="pull-left" id="testing-status">{{ text_running_tests }}</span>
                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="panel panel-red">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-3">
                                <i class="fa fa-exclamation-triangle fa-5x"></i>
                            </div>
                            <div class="col-xs-9 text-right">
                                <div class="huge" id="failed-builds">0</div>
                                <div>{{ text_failed_builds }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <span class="pull-left" id="builds-status">{{ text_monitoring }}</span>
                        <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Performance Charts -->
        <div class="row">
            <div class="col-lg-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-line-chart fa-fw"></i> {{ text_pipeline_performance }}
                    </div>
                    <div class="panel-body">
                        <canvas id="pipelinePerformanceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-pie-chart fa-fw"></i> {{ text_deployment_strategies }}
                    </div>
                    <div class="panel-body">
                        <canvas id="deploymentStrategiesChart" width="200" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- CI/CD Pipelines -->
        <div class="row">
            <div class="col-lg-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-code-fork fa-fw"></i> {{ text_cicd_pipelines }}
                        <div class="pull-right">
                            <button type="button" class="btn btn-xs btn-success" id="create-pipeline">
                                <i class="fa fa-plus"></i> {{ text_new_pipeline }}
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{{ text_pipeline_name }}</th>
                                        <th>{{ text_branch }}</th>
                                        <th>{{ text_status }}</th>
                                        <th>{{ text_duration }}</th>
                                        <th>{{ text_last_run }}</th>
                                        <th>{{ text_actions }}</th>
                                    </tr>
                                </thead>
                                <tbody id="pipelines-table">
                                    <tr>
                                        <td colspan="6" class="text-center">{{ text_loading }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-git fa-fw"></i> {{ text_gitops_workflows }}
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>{{ text_repository }}</label>
                            <select class="form-control" id="gitops-repository">
                                <option value="">{{ text_select_repository }}</option>
                                <option value="meschain-sync">meschain-sync</option>
                                <option value="meschain-api">meschain-api</option>
                                <option value="meschain-worker">meschain-worker</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>{{ text_target_branch }}</label>
                            <select class="form-control" id="gitops-branch">
                                <option value="main">main</option>
                                <option value="develop">develop</option>
                                <option value="staging">staging</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary btn-block" id="trigger-gitops">
                            <i class="fa fa-git"></i> {{ text_trigger_gitops }}
                        </button>
                        
                        <hr>
                        
                        <h5>{{ text_recent_commits }}</h5>
                        <div id="recent-commits">
                            <div class="text-center">{{ text_loading_commits }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing & Quality -->
        <div class="row">
            <div class="col-lg-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-flask fa-fw"></i> {{ text_automated_testing }}
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>{{ text_test_suite }}</label>
                                    <select class="form-control" id="test-suite">
                                        <option value="unit">{{ text_unit_tests }}</option>
                                        <option value="integration">{{ text_integration_tests }}</option>
                                        <option value="e2e">{{ text_e2e_tests }}</option>
                                        <option value="performance">{{ text_performance_tests }}</option>
                                        <option value="security">{{ text_security_tests }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>{{ text_environment }}</label>
                                    <select class="form-control" id="test-environment">
                                        <option value="local">{{ text_local }}</option>
                                        <option value="staging">{{ text_staging }}</option>
                                        <option value="production">{{ text_production }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-warning btn-block" id="run-tests">
                            <i class="fa fa-flask"></i> {{ text_run_tests }}
                        </button>
                        
                        <hr>
                        
                        <div class="progress-group">
                            <span class="progress-text">{{ text_unit_tests }}</span>
                            <span class="float-right"><b id="unit-test-progress">0</b>/100</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-success" id="unit-test-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">{{ text_integration_tests }}</span>
                            <span class="float-right"><b id="integration-test-progress">0</b>/100</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-info" id="integration-test-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">{{ text_code_coverage }}</span>
                            <span class="float-right"><b id="coverage-progress">0</b>%</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-warning" id="coverage-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-rocket fa-fw"></i> {{ text_deployment_automation }}
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>{{ text_deployment_strategy }}</label>
                                    <select class="form-control" id="deployment-strategy">
                                        <option value="rolling">{{ text_rolling_update }}</option>
                                        <option value="blue_green">{{ text_blue_green }}</option>
                                        <option value="canary">{{ text_canary }}</option>
                                        <option value="a_b_test">{{ text_a_b_test }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>{{ text_target_environment }}</label>
                                    <select class="form-control" id="deployment-environment">
                                        <option value="staging">{{ text_staging }}</option>
                                        <option value="production">{{ text_production }}</option>
                                        <option value="canary">{{ text_canary_env }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success btn-block" id="trigger-deployment">
                            <i class="fa fa-rocket"></i> {{ text_trigger_deployment }}
                        </button>
                        
                        <hr>
                        
                        <h5>{{ text_deployment_history }}</h5>
                        <div id="deployment-history">
                            <div class="text-center">{{ text_loading_deployments }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DORA Metrics -->
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <i class="fa fa-dashboard fa-fw"></i> {{ text_dora_metrics }}
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="description-block border-right">
                                    <span class="description-percentage text-green" id="deployment-frequency">0</span>
                                    <h5 class="description-header">{{ text_deployment_frequency }}</h5>
                                    <span class="description-text">{{ text_per_day }}</span>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="description-block border-right">
                                    <span class="description-percentage text-blue" id="lead-time">0</span>
                                    <h5 class="description-header">{{ text_lead_time }}</h5>
                                    <span class="description-text">{{ text_hours }}</span>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="description-block border-right">
                                    <span class="description-percentage text-yellow" id="mttr">0</span>
                                    <h5 class="description-header">{{ text_mttr }}</h5>
                                    <span class="description-text">{{ text_minutes }}</span>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="description-block">
                                    <span class="description-percentage text-red" id="change-failure-rate">0%</span>
                                    <h5 class="description-header">{{ text_change_failure_rate }}</h5>
                                    <span class="description-text">{{ text_failure_percentage }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Infrastructure as Code -->
        <div class="row">
            <div class="col-lg-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-code fa-fw"></i> {{ text_infrastructure_as_code }}
                    </div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>{{ text_template_name }}</th>
                                        <th>{{ text_provider }}</th>
                                        <th>{{ text_status }}</th>
                                        <th>{{ text_last_applied }}</th>
                                        <th>{{ text_actions }}</th>
                                    </tr>
                                </thead>
                                <tbody id="iac-templates-table">
                                    <tr>
                                        <td colspan="5" class="text-center">{{ text_loading }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-bell fa-fw"></i> {{ text_alerts_notifications }}
                    </div>
                    <div class="panel-body">
                        <div id="devops-alerts">
                            <div class="text-center">{{ text_loading_alerts }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-history fa-fw"></i> {{ text_recent_activities }}
                    </div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>{{ text_timestamp }}</th>
                                        <th>{{ text_activity_type }}</th>
                                        <th>{{ text_description }}</th>
                                        <th>{{ text_user }}</th>
                                        <th>{{ text_status }}</th>
                                    </tr>
                                </thead>
                                <tbody id="activities-table">
                                    <tr>
                                        <td colspan="5" class="text-center">{{ text_loading }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pipeline Modal -->
<div class="modal fade" id="pipelineModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">{{ text_create_new_pipeline }}</h4>
            </div>
            <div class="modal-body">
                <form id="pipeline-form">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label>{{ text_pipeline_name }}</label>
                                <input type="text" class="form-control" id="pipeline-name" required>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label>{{ text_repository_url }}</label>
                                <input type="text" class="form-control" id="pipeline-repo" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label>{{ text_branch }}</label>
                                <input type="text" class="form-control" id="pipeline-branch" value="main">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label>{{ text_trigger_type }}</label>
                                <select class="form-control" id="pipeline-trigger">
                                    <option value="push">{{ text_on_push }}</option>
                                    <option value="pull_request">{{ text_on_pull_request }}</option>
                                    <option value="schedule">{{ text_scheduled }}</option>
                                    <option value="manual">{{ text_manual }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <label>{{ text_pipeline_stages }}</label>
                            <div class="checkbox">
                                <label><input type="checkbox" id="stage-checkout" checked disabled> {{ text_source_checkout }}</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="stage-analysis" checked> {{ text_code_analysis }}</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="stage-tests" checked> {{ text_automated_tests }}</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="stage-security" checked> {{ text_security_scan }}</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="stage-build" checked> {{ text_docker_build }}</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="stage-deploy"> {{ text_auto_deploy }}</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{{ text_cancel }}</button>
                <button type="button" class="btn btn-success" id="create-pipeline-btn">{{ text_create_pipeline }}</button>
            </div>
        </div>
    </div>
</div>

<style>
.panel-green {
    border-color: #5cb85c;
}
.panel-green > .panel-heading {
    border-color: #5cb85c;
    color: white;
    background-color: #5cb85c;
}

.panel-yellow {
    border-color: #f0ad4e;
}
.panel-yellow > .panel-heading {
    border-color: #f0ad4e;
    color: white;
    background-color: #f0ad4e;
}

.panel-red {
    border-color: #d9534f;
}
.panel-red > .panel-heading {
    border-color: #d9534f;
    color: white;
    background-color: #d9534f;
}

.huge {
    font-size: 40px;
}

.progress-group {
    margin-bottom: 15px;
}

.description-block {
    text-align: center;
    padding: 15px;
}

.description-percentage {
    font-size: 2em;
    font-weight: bold;
}

.description-header {
    margin: 10px 0 5px 0;
    font-size: 16px;
}

.description-text {
    color: #999;
    font-size: 12px;
}

.border-right {
    border-right: 1px solid #f0f0f0;
}

.text-green { color: #5cb85c !important; }
.text-blue { color: #337ab7 !important; }
.text-yellow { color: #f0ad4e !important; }
.text-red { color: #d9534f !important; }

.status-badge {
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}

.status-success { background-color: #5cb85c; color: white; }
.status-running { background-color: #337ab7; color: white; }
.status-failed { background-color: #d9534f; color: white; }
.status-pending { background-color: #f0ad4e; color: white; }

.bg-success { background-color: #5cb85c !important; }
.bg-info { background-color: #5bc0de !important; }
.bg-warning { background-color: #f0ad4e !important; }

.commit-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    font-size: 12px;
}

.deployment-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    font-size: 12px;
}

.alert-item {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-size: 12px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    let performanceChart, strategiesChart;
    
    // Initialize Charts
    function initializeCharts() {
        // Pipeline Performance Chart
        const performanceCtx = document.getElementById('pipelinePerformanceChart').getContext('2d');
        performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '{{ text_build_time }}',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: '{{ text_test_time }}',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }, {
                    label: '{{ text_deploy_time }}',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Deployment Strategies Chart
        const strategiesCtx = document.getElementById('deploymentStrategiesChart').getContext('2d');
        strategiesChart = new Chart(strategiesCtx, {
            type: 'doughnut',
            data: {
                labels: ['{{ text_rolling_update }}', '{{ text_blue_green }}', '{{ text_canary }}', '{{ text_a_b_test }}'],
                datasets: [{
                    data: [60, 25, 10, 5],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Load DevOps Data
    function loadDevOpsData() {
        $.ajax({
            url: 'index.php?route=extension/module/devops_automation_dashboard/getDevOpsMetrics&user_token={{ user_token }}',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                updateDashboard(data);
            },
            error: function() {
                console.error('Failed to load DevOps data');
            }
        });
    }

    // Update Dashboard
    function updateDashboard(data) {
        // Update overview cards
        $('#active-pipelines').text(data.overview.active_pipelines || 0);
        $('#successful-deployments').text(data.overview.successful_deployments || 0);
        $('#test-coverage').text((data.overview.test_coverage || 0) + '%');
        $('#failed-builds').text(data.overview.failed_builds || 0);

        // Update status messages
        $('#pipelines-status').text(data.overview.pipelines_status || '{{ text_loading }}');
        $('#deployments-status').text(data.overview.deployments_status || '{{ text_healthy }}');
        $('#testing-status').text(data.overview.testing_status || '{{ text_running_tests }}');
        $('#builds-status').text(data.overview.builds_status || '{{ text_monitoring }}');

        // Update DORA metrics
        $('#deployment-frequency').text(data.dora.deployment_frequency || 0);
        $('#lead-time').text(data.dora.lead_time || 0);
        $('#mttr').text(data.dora.mttr || 0);
        $('#change-failure-rate').text((data.dora.change_failure_rate || 0) + '%');

        // Update test progress
        $('#unit-test-progress').text(data.testing.unit_tests || 0);
        $('#unit-test-bar').css('width', (data.testing.unit_tests || 0) + '%');
        $('#integration-test-progress').text(data.testing.integration_tests || 0);
        $('#integration-test-bar').css('width', (data.testing.integration_tests || 0) + '%');
        $('#coverage-progress').text(data.testing.coverage || 0);
        $('#coverage-bar').css('width', (data.testing.coverage || 0) + '%');

        // Update tables
        updatePipelinesTable(data.pipelines || []);
        updateIaCTemplatesTable(data.iac_templates || []);
        updateActivitiesTable(data.activities || []);

        // Update other sections
        updateRecentCommits(data.recent_commits || []);
        updateDeploymentHistory(data.deployment_history || []);
        updateDevOpsAlerts(data.alerts || []);

        // Update charts
        updateCharts(data.metrics || {});
    }

    // Update Pipelines Table
    function updatePipelinesTable(pipelines) {
        let html = '';
        if (pipelines.length === 0) {
            html = '<tr><td colspan="6" class="text-center">{{ text_no_pipelines }}</td></tr>';
        } else {
            pipelines.forEach(function(pipeline) {
                html += `
                    <tr>
                        <td><strong>${pipeline.name}</strong></td>
                        <td><code>${pipeline.branch}</code></td>
                        <td><span class="status-badge status-${pipeline.status}">${pipeline.status}</span></td>
                        <td>${pipeline.duration || 'N/A'}</td>
                        <td>${pipeline.last_run || 'Never'}</td>
                        <td>
                            <div class="btn-group btn-group-xs">
                                <button class="btn btn-info" onclick="viewPipelineLogs('${pipeline.id}')">
                                    <i class="fa fa-file-text"></i>
                                </button>
                                <button class="btn btn-success" onclick="triggerPipeline('${pipeline.id}')">
                                    <i class="fa fa-play"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deletePipeline('${pipeline.id}')">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        $('#pipelines-table').html(html);
    }

    // Update IaC Templates Table
    function updateIaCTemplatesTable(templates) {
        let html = '';
        if (templates.length === 0) {
            html = '<tr><td colspan="5" class="text-center">{{ text_no_templates }}</td></tr>';
        } else {
            templates.forEach(function(template) {
                html += `
                    <tr>
                        <td><strong>${template.name}</strong></td>
                        <td>${template.provider}</td>
                        <td><span class="status-badge status-${template.status}">${template.status}</span></td>
                        <td>${template.last_applied || 'Never'}</td>
                        <td>
                            <div class="btn-group btn-group-xs">
                                <button class="btn btn-info" onclick="planIaC('${template.id}')">
                                    <i class="fa fa-search"></i>
                                </button>
                                <button class="btn btn-warning" onclick="applyIaC('${template.id}')">
                                    <i class="fa fa-play"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        $('#iac-templates-table').html(html);
    }

    // Update Activities Table
    function updateActivitiesTable(activities) {
        let html = '';
        if (activities.length === 0) {
            html = '<tr><td colspan="5" class="text-center">{{ text_no_activities }}</td></tr>';
        } else {
            activities.forEach(function(activity) {
                html += `
                    <tr>
                        <td>${activity.timestamp}</td>
                        <td><span class="label label-info">${activity.type}</span></td>
                        <td>${activity.description}</td>
                        <td>${activity.user}</td>
                        <td><span class="status-badge status-${activity.status}">${activity.status}</span></td>
                    </tr>
                `;
            });
        }
        $('#activities-table').html(html);
    }

    // Update Recent Commits
    function updateRecentCommits(commits) {
        let html = '';
        if (commits.length === 0) {
            html = '<div class="text-center">{{ text_no_commits }}</div>';
        } else {
            commits.forEach(function(commit) {
                html += `
                    <div class="commit-item">
                        <strong>${commit.message}</strong><br>
                        <small>${commit.author} - ${commit.timestamp}</small>
                    </div>
                `;
            });
        }
        $('#recent-commits').html(html);
    }

    // Update Deployment History
    function updateDeploymentHistory(deployments) {
        let html = '';
        if (deployments.length === 0) {
            html = '<div class="text-center">{{ text_no_deployments }}</div>';
        } else {
            deployments.forEach(function(deployment) {
                const statusClass = deployment.status === 'success' ? 'success' : 'danger';
                html += `
                    <div class="deployment-item">
                        <span class="label label-${statusClass}">${deployment.environment}</span>
                        <strong>${deployment.version}</strong><br>
                        <small>${deployment.timestamp}</small>
                    </div>
                `;
            });
        }
        $('#deployment-history').html(html);
    }

    // Update DevOps Alerts
    function updateDevOpsAlerts(alerts) {
        let html = '';
        if (alerts.length === 0) {
            html = '<div class="text-center">{{ text_no_alerts }}</div>';
        } else {
            alerts.forEach(function(alert) {
                const alertClass = alert.severity === 'high' ? 'danger' : (alert.severity === 'medium' ? 'warning' : 'info');
                html += `
                    <div class="alert alert-${alertClass} alert-item">
                        <strong>${alert.title}</strong><br>
                        <small>${alert.message}</small>
                    </div>
                `;
            });
        }
        $('#devops-alerts').html(html);
    }

    // Update Charts
    function updateCharts(metrics) {
        if (metrics.timeline) {
            performanceChart.data.labels = metrics.timeline;
            performanceChart.data.datasets[0].data = metrics.build_times || [];
            performanceChart.data.datasets[1].data = metrics.test_times || [];
            performanceChart.data.datasets[2].data = metrics.deploy_times || [];
            performanceChart.update();
        }

        if (metrics.deployment_strategies) {
            strategiesChart.data.datasets[0].data = metrics.deployment_strategies;
            strategiesChart.update();
        }
    }

    // Event Handlers
    $('#refresh-devops-data').click(function() {
        loadDevOpsData();
    });

    $('#export-devops-report').click(function() {
        window.location.href = 'index.php?route=extension/module/devops_automation_dashboard/exportReport&user_token={{ user_token }}';
    });

    $('#trigger-pipeline, #create-pipeline').click(function() {
        $('#pipelineModal').modal('show');
    });

    $('#create-pipeline-btn').click(function() {
        createPipeline();
    });

    $('#trigger-gitops').click(function() {
        triggerGitOpsWorkflow();
    });

    $('#run-tests').click(function() {
        runAutomatedTests();
    });

    $('#trigger-deployment').click(function() {
        triggerDeployment();
    });

    // Functions
    function createPipeline() {
        const pipelineData = {
            name: $('#pipeline-name').val(),
            repository_url: $('#pipeline-repo').val(),
            branch: $('#pipeline-branch').val(),
            trigger_type: $('#pipeline-trigger').val(),
            stages: {
                checkout: $('#stage-checkout').is(':checked'),
                analysis: $('#stage-analysis').is(':checked'),
                tests: $('#stage-tests').is(':checked'),
                security: $('#stage-security').is(':checked'),
                build: $('#stage-build').is(':checked'),
                deploy: $('#stage-deploy').is(':checked')
            }
        };

        $.ajax({
            url: 'index.php?route=extension/module/devops_automation_dashboard/createPipeline&user_token={{ user_token }}',
            type: 'POST',
            data: pipelineData,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    alert('{{ text_pipeline_created }}');
                    $('#pipelineModal').modal('hide');
                    loadDevOpsData();
                } else {
                    alert('{{ text_pipeline_creation_failed }}: ' + response.error);
                }
            },
            error: function() {
                alert('{{ text_pipeline_creation_error }}');
            }
        });
    }

    function triggerGitOpsWorkflow() {
        const workflowData = {
            repository: $('#gitops-repository').val(),
            branch: $('#gitops-branch').val()
        };

        if (!workflowData.repository) {
            alert('{{ text_select_repository_first }}');
            return;
        }

        $.ajax({
            url: 'index.php?route=extension/module/devops_automation_dashboard/triggerGitOps&user_token={{ user_token }}',
            type: 'POST',
            data: workflowData,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    alert('{{ text_gitops_triggered }}');
                    loadDevOpsData();
                } else {
                    alert('{{ text_gitops_failed }}: ' + response.error);
                }
            },
            error: function() {
                alert('{{ text_gitops_error }}');
            }
        });
    }

    function runAutomatedTests() {
        const testData = {
            test_suite: $('#test-suite').val(),
            environment: $('#test-environment').val()
        };

        $.ajax({
            url: 'index.php?route=extension/module/devops_automation_dashboard/runTests&user_token={{ user_token }}',
            type: 'POST',
            data: testData,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    alert('{{ text_tests_started }}');
                    loadDevOpsData();
                } else {
                    alert('{{ text_tests_failed }}: ' + response.error);
                }
            },
            error: function() {
                alert('{{ text_tests_error }}');
            }
        });
    }

    function triggerDeployment() {
        const deploymentData = {
            strategy: $('#deployment-strategy').val(),
            environment: $('#deployment-environment').val()
        };

        $.ajax({
            url: 'index.php?route=extension/module/devops_automation_dashboard/triggerDeployment&user_token={{ user_token }}',
            type: 'POST',
            data: deploymentData,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    alert('{{ text_deployment_started }}');
                    loadDevOpsData();
                } else {
                    alert('{{ text_deployment_failed }}: ' + response.error);
                }
            },
            error: function() {
                alert('{{ text_deployment_error }}');
            }
        });
    }

    // Global functions for table actions
    window.viewPipelineLogs = function(pipelineId) {
        // Implementation for viewing pipeline logs
    };

    window.triggerPipeline = function(pipelineId) {
        // Implementation for triggering specific pipeline
    };

    window.deletePipeline = function(pipelineId) {
        if (confirm('{{ text_confirm_delete_pipeline }}')) {
            // Implementation for deleting pipeline
        }
    };

    window.planIaC = function(templateId) {
        // Implementation for IaC planning
    };

    window.applyIaC = function(templateId) {
        // Implementation for IaC application
    };

    // Initialize
    initializeCharts();
    loadDevOpsData();
    
    // Auto-refresh every 30 seconds
    setInterval(loadDevOpsData, 30000);
});
</script>

{{ footer }} 